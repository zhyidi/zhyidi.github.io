# Linux下Screen命令的使用

## 一、 screen基础概念

### 1. 背景

系统管理员经常需要SSH或者telent远程登录到Linux 服务器，经常运行一些需要很长时间才能完成的任务，比如系统备份、ftp传输等等。通常情况下我们都是为每一个这样的任务开一个远程终端窗口，因为它们执行的时间太长了。必须等待它们执行完毕，在此期间不能关掉窗口或者断开连接，否则这个任务就会被杀掉，一切半途而废了。screen命令可以很好的解决这个问题。**实现在断开SSH的情况下,在服务器上继续执行程序。**

### 2. screen介绍

GNU Screen简称screen，源自GNU计划，其官网：[GNU Screen](http://www.gnu.org/software/screen/)。

Screen的功能大体有三个：

- 会话恢复：**只要Screen本身没有终止，在其内部运行的会话都可以恢复。**这一点对于远程登录的用户特别有用——即使网络连接中断，用户也不会失去对已经打开的命令行会话的控制。只要再次登录到主机上执行screen -r 就可以恢复会话的运行。同样在暂时离开的时候，也可以执行分离命令detach，在保证里面的程序正常运行的情况下让Screen挂起（切换到后台）。这一点和图形界面下的VNC很相似。
- 多窗口：在Screen环境下，**所有的会话都独立的运行，并拥有各自的编号、输入、输出和窗口缓存。**用户可以通过快捷键在不同的窗口下切换，并可以自由的重定向各个窗口的输入和输出。
- 会话共享：Screen可以让一个或多个用户从不同终端多次登录一个会话，并共享会话的所有特性（比如可以看到完全相同的输出）。它同时提供了窗口访问权限的机制，可以对窗口进行密码保护。

这三个功能，其实互相交织，组成screen功能繁多的命令集。

### 3. screen基础概念

Screen被称之为一个全屏窗口管理器, 用户可以通过该软件同时连接多个本地或远程的命令行会话，并在其间自由切换。注意有`会话(session)`和`窗口(window)`两个概念。

- 默认窗口：所谓默认窗口就是我们没有用screen命令时的那个干干净净的窗口，不能使用等会介绍的screen命令下的任何快捷键。
- screen会话：screen会话就是当我们进入screen空间下时，占用了一个进程pid的一个界面。这个界面有他自己的名字，有他自己内部交互的快捷键，能够拥有很多不同的子终端的界面。也可以理解成独立于默认窗口之外的窗口。注意，是每一个screen会话都能拥有很多的子窗口，而我们的电脑能同时拥有很多不同的screen会话。
- 子窗口window：每一个子窗口都是附属与一个screen会话下的，他们互不影响，能够分别执行不同的命令，**这是整个screen命令的精华所在**。对窗口进行管理，管理命令以`ctrl + a`开头。 工作时，我们需要做的就是选定某一个screen会话，并且选定一个子窗口。

## 二、 screen使用

### 1. 安装Screen

```
# 首先查看是否安装了screen
screen --version
# 安装screen
apt/yum install screen
```

### 2. screen基础命令

#### 2.1 命令格式

screen，通常的命令格式为：

```
screen [-opts] [cmd [args]]
```

通常情况下，使用一下`基础命令`即可，`高阶命令`过多，比较难记。

注意：命令区分大小写。

#### 2.2 帮助查询

screen的帮助文档实在是过于详细，以至于查个命令，可能要查几分钟；但是你可以直接使用帮助命令，查询自己需要的命令:

```
# 查询screen提示
screen -help
```

通过这个命令，可以查询到大部常用命令。

![image-20230407112343926](https://cdn.yidi.space/sakura/article_images/screen/image-20230407112343926.png)

#### 2.3 会话管理

##### 2.3.1 会话列表

怎么查看已经存在的screen会话呢？很简单，使用命令：

```
screen -ls
```

即可查看已经创建（在后台运行的会话）。

##### 2.3.2 状态介绍

通常情况下，screen创建的会话，有两个工作模式：

- ***Attached***：表示当前screen正在作为主终端使用，为活跃状态。
- ***Detached***：表示当前screen正在后台使用，为非激发状态。

通常情况下，不需要关注上面的状态。

![image-20230407113531656](https://cdn.yidi.space/sakura/article_images/screen/image-20230407113531656.png)

##### 2.3.3 新建会话

直接输入screen回车，即可新建一个会话，**但是这样会以Linux的hostname给会话命名）**。可以使用`-S`参数自行命名。

```
# 创建一个叫Hello的会话
screen -S Hello
```

也可使用`-R`创建会话：

```
# 使用-R创建Hello
screen -R Hello
```

三种创建方法比较：

- 使用`-R`创建，如果之前有创建唯一一个同名的screen会话，则直接进入之前创建的screen会话。
- 使用`-S`创建和直接输入`screen`创建会话，不会检录之前创建的screen会话（**也就是会创建同名的screen会话**)。

创建完成会进入screen会话，我们按`Ctril+a`，再按`d`，即可保持这个screen会话到后台并回到主终端。

##### 2.3.4 回到终端

刚刚我们介绍了创建screen会话，并回到主终端的方法。那么，**如何重新回到某个screen会话呢？**

很简单，使用`-R`或者`-r`命令即可：

```
# 使用screen -r命令
screen -r [pid/name]
```

其中，pid/name：为会话的PID或Name。

![image-20230407112941292](https://cdn.yidi.space/sakura/article_images/screen/image-20230407112941292.png)

##### 2.3.5 清除会话

有时候，我们的进程已经“守护”完毕，不需要这个screen会话了，也就是需要释放资源，如何操作呢？

比较推荐的方法，是进入对应会话，然后输入：

```
# 退出终端
exit
```

成功终止后，如果有其他处于Attached状态的screen界面，他就会跳到那个界面中，如果没有，他就会跳到主终端上。

当然，你如果对screen运行程序，确定已经停止运行了，也可以在主终端内，使用命令释放：

```
# 使用-R/-r/-S均可
screen -R [pid/Name] -X quit
```

#### 2.4 窗口管理

##### 2.4.1 新建子窗口

```
Ctrl-a c #在当前的会话下面生成一个新的窗口并切换过去
```

##### 2.4.2 列出所有子窗口

```
Ctrl-a w #列出当前窗口
```

##### 2.4.3 切换子窗口

```
Ctrl-a a #在最近的两个窗口之间切换
```

##### 2.4.4 dettach子窗口

```
Ctrl+a d #进入screen窗口后，想暂时退出（等会还想连接这个screen窗口）
```

##### 2.4.5 窗口命名

```
Ctrl-a A #会允许你输入新的名字
```

### 3. screen高级应用

#### 3.1 会话共享

假设你在和朋友在不同地点以相同用户登录同一台机器，然后你创建一个screen会话，你朋友可以在他的终端上命令：

```
screen -x
```

这个命令会将你朋友的终端Attach到你的Screen会话上，并且你的终端不会被Dettach。这样你就可以和朋友共享同一个会话了，如果你们当前又处于同一个窗口，那就相当于坐在同一个显示器前面，你的操作会同步演示给你朋友，你朋友的操作也会同步演示给你。当然，如果你们切换到这个会话的不同窗口中去，那还是可以分别进行不同的操作的。

#### 3.2 会话锁定与解锁

Screen允许使用快捷键`Ctrl-a s`锁定会话。锁定以后，再进行任何输入屏幕都不会再有反应了。但是要注意虽然屏幕上看不到反应，但你的输入都会被Screen中的进程接收到。快捷键`Ctrl-a q`可以解锁一个会话。

也可以使用`Ctrl-a x`锁定会话，不同的是这样锁定之后，会话会被Screen所属用户的密码保护，需要输入密码才能继续访问这个会话。
